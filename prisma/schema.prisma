generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main user profile table (separate from Supabase auth.users)
model UserApp {
  userId          String    @id @db.Uuid
  email           String    @unique
  fullName        String?   @map("full_name")
  phone           String?   @map("phone")
  organization    String?   @map("organization")
  profilePic      String?   @map("profile_pic")
  plan            Plan      @default(FREE)
  usageCount      Int       @default(0) @map("usage_count")
  expiryDate      DateTime? @map("expiry_date")
  themePreference String?   @default("system") @map("theme_preference")
  settings        Json?     @map("settings")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  payments     Payment[]
  usageEvents  UsageEvent[]
  research     Research[]
  drafts       Draft[]
  summaries    Summary[]
  caseTracker  CaseTracker[]
  notices      Notice[]
  crm          CRM[]
  acts         Act[]
  news         News[]
  chatSessions ChatSession[]
  uploadedFiles UploadedFile[]
  auditLogs    AuditLog[]

  @@map("users_app")
}

// Payment records
model Payment {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @map("user_id") @db.Uuid
  plan              Plan
  amount            Int
  currency          String        @default("INR")
  razorpayOrderId   String        @map("razorpay_order_id")
  razorpayPaymentId String?       @map("razorpay_payment_id")
  razorpaySignature String?       @map("razorpay_signature")
  status            PaymentStatus @default(CREATED)
  createdAt         DateTime      @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("payments")
}

// Usage tracking
model UsageEvent {
  id        String      @id @default(uuid()) @db.Uuid
  userId    String      @map("user_id") @db.Uuid
  feature   FeatureType
  count     Int         @default(1)
  createdAt DateTime    @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, feature], name: "userId_feature")
  @@index([userId, createdAt])
  @@map("usage_events")
}

// Research queries
model Research {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  query     String
  result    String
  type      String   @default("general")
  createdAt DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("research")
}

// Legal drafts
model Draft {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  title     String
  content   String
  inputs    Json
  pdfUrl    String?  @map("pdf_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("drafts")
}

// Judgment summaries
model Summary {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  title        String
  originalText String   @map("original_text")
  summary      String
  fileUrl      String?  @map("file_url")
  createdAt    DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("summaries")
}

// Case tracking
model CaseTracker {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  cnr        String    @unique
  partyName  String    @map("party_name")
  court      String
  status     String
  nextDate   DateTime? @map("next_date")
  lastUpdate DateTime  @map("last_update")
  details    Json?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("case_tracker")
}

// Legal notices
model Notice {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  title     String
  content   String
  recipient String
  status    String   @default("draft")
  pdfUrl    String?  @map("pdf_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("notices")
}

// CRM data
model CRM {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  clientName  String    @map("client_name")
  clientEmail String?   @map("client_email")
  clientPhone String?   @map("client_phone")
  title       String
  description String?
  date        DateTime
  duration    Int       @default(60)
  status      String    @default("scheduled")
  reminders   Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("crm")
}

// Acts data
model Act {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  year      String
  actId     String   @map("act_id")
  content   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("acts")
}

// News articles
model News {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String
  content     String
  summary     String?
  source      String
  url         String
  publishedAt DateTime @map("published_at")
  category    String?
  tags        String[]
  createdAt   DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("news")
}

// Chat sessions
model ChatSession {
  id        String        @id @default(uuid()) @db.Uuid
  userId    String        @map("user_id") @db.Uuid
  caseId    String?       @map("case_id") @db.Uuid
  title     String
  messages  ChatMessage[]
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@map("chat_sessions")
}

// Chat messages
model ChatMessage {
  id          String      @id @default(uuid()) @db.Uuid
  sessionId   String      @map("session_id") @db.Uuid
  role        String      // 'user' | 'assistant'
  content     String
  citations   String[]
  attachments Json?       // File attachments metadata
  createdAt   DateTime    @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

// Uploaded files
model UploadedFile {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  filename   String
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  content    String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("uploaded_files")
}

// Audit logs
model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  action    String
  resource  String
  details   String?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  timestamp DateTime @default(now())

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, timestamp])
  @@map("audit_logs")
}

// Enums
enum Plan {
  FREE
  BASIC
  PLUS
  PRO
}

enum PaymentStatus {
  CREATED
  PAID
  FAILED
}

// Rate limiting table
model RateLimit {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  count     Int      @default(1)
  resetTime DateTime @map("reset_time")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([key, resetTime])
  @@map("rate_limits")
}

enum FeatureType {
  AI_ASSISTANT
  DOC_GENERATOR
  JUDGMENT_SUMMARIZER
  CRM
  ACTS
  NEWS
  CASE_TRACKER
  NOTICES
  DRAFTS
  RESEARCH
}