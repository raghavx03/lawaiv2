generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// Main user profile table (separate from Supabase auth.users)
model UserApp {
  userId          String    @id @db.Uuid
  email           String    @unique
  fullName        String?   @map("full_name")
  phone           String?   @map("phone")
  organization    String?   @map("organization")
  profilePic      String?   @map("profile_pic")
  plan            Plan      @default(FREE)
  usageCount      Int       @default(0) @map("usage_count")
  expiryDate      DateTime? @map("expiry_date")
  themePreference String?   @default("system") @map("theme_preference")
  settings        Json?     @map("settings")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  payments      Payment[]
  usageEvents   UsageEvent[]
  research      Research[]
  drafts        Draft[]
  summaries     Summary[]
  caseTracker   CaseTracker[]
  notices       Notice[]
  crm           CRM[]
  acts          Act[]
  news          News[]
  chatSessions  ChatSession[]
  uploadedFiles UploadedFile[]
  auditLogs     AuditLog[]
  cases         Case[]
  clients       Client[]
  notifications Notification[]

  @@map("users_app")
}

// ============================================
// CASE-CENTRIC ARCHITECTURE - CORE MODELS
// ============================================

// Case - The central entity everything revolves around
model Case {
  id              String       @id @default(uuid()) @db.Uuid
  userId          String       @map("user_id") @db.Uuid
  
  // Basic Info
  title           String       // Case title/name
  cnrNumber       String?      @map("cnr_number") // CNR if tracked
  caseNumber      String?      @map("case_number") // Court case number
  caseType        CaseType     @default(GENERAL) @map("case_type")
  
  // Court Details
  court           String?      // Court name
  judge           String?      // Assigned judge
  courtRoom       String?      @map("court_room")
  
  // Parties
  petitioner      String?      // Petitioner/Plaintiff name
  respondent      String?      // Respondent/Defendant name
  clientId        String?      @map("client_id") @db.Uuid
  clientRole      ClientRole?  @map("client_role") // Is client petitioner or respondent?
  
  // Status & Dates
  status          CaseStatus   @default(OPEN)
  stage           CaseStage    @default(FILING)
  filingDate      DateTime?    @map("filing_date")
  nextHearing     DateTime?    @map("next_hearing")
  disposedDate    DateTime?    @map("disposed_date")
  
  // AI Generated
  aiSummary       String?      @map("ai_summary") // AI-generated case summary
  aiPrediction    String?      @map("ai_prediction") // AI predicted next steps
  
  // Metadata
  priority        Priority     @default(MEDIUM)
  tags            String[]     @default([])
  notes           String?      // General notes
  details         Json?        // Additional flexible data
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  user            UserApp      @relation(fields: [userId], references: [userId], onDelete: Cascade)
  client          Client?      @relation(fields: [clientId], references: [id])
  activities      CaseActivity[]
  hearings        Hearing[]
  documents       CaseDocument[]

  @@unique([userId, cnrNumber])
  @@index([userId, status])
  @@index([userId, nextHearing])
  @@map("cases")
}

// CaseActivity - Timeline of all activities (THE BACKBONE)
model CaseActivity {
  id          String         @id @default(uuid()) @db.Uuid
  caseId      String         @map("case_id") @db.Uuid
  userId      String         @map("user_id") @db.Uuid
  
  // Activity Type
  type        ActivityType
  feature     FeatureType?   // Which feature created this
  
  // Content
  title       String         // Short title
  content     String         // Main content (AI response, draft content, etc.)
  metadata    Json?          // Additional data (inputs, citations, etc.)
  
  // References
  referenceId String?        @map("reference_id") // ID of related entity (draft, summary, etc.)
  
  createdAt   DateTime       @default(now()) @map("created_at")

  case        Case           @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
  @@index([caseId, type])
  @@map("case_activities")
}

// Hearing - Court hearings for a case
model Hearing {
  id          String        @id @default(uuid()) @db.Uuid
  caseId      String        @map("case_id") @db.Uuid
  
  date        DateTime
  time        String?
  purpose     String?       // Purpose of hearing
  courtRoom   String?       @map("court_room")
  judge       String?
  
  // Outcome
  status      HearingStatus @default(SCHEDULED)
  outcome     String?       // What happened
  nextSteps   String?       @map("next_steps")
  orderSummary String?      @map("order_summary") // AI summary of order
  
  // Reminders
  reminderSent Boolean      @default(false) @map("reminder_sent")
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  case        Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, date])
  @@map("hearings")
}

// CaseDocument - Documents attached to a case
model CaseDocument {
  id          String       @id @default(uuid()) @db.Uuid
  caseId      String       @map("case_id") @db.Uuid
  
  name        String
  type        DocumentType
  fileUrl     String?      @map("file_url")
  content     String?      // Extracted text content
  summary     String?      // AI summary
  
  createdAt   DateTime     @default(now()) @map("created_at")

  case        Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  embeddings  DocumentEmbedding[]

  @@index([caseId])
  @@map("case_documents")
}

// Client - CRM linked to cases
model Client {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  
  name        String
  email       String?
  phone       String?
  address     String?
  
  // Payment tracking
  totalBilled Decimal?  @map("total_billed") @db.Decimal(10, 2)
  totalPaid   Decimal?  @map("total_paid") @db.Decimal(10, 2)
  
  notes       String?
  tags        String[]  @default([])
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        UserApp   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  cases       Case[]

  @@index([userId])
  @@map("clients")
}

// ============================================
// ENUMS FOR CASE-CENTRIC SYSTEM
// ============================================

enum CaseType {
  GENERAL
  CRIMINAL
  CIVIL
  FAMILY
  PROPERTY
  CONSUMER
  LABOUR
  TAX
  CORPORATE
  WRIT
  ARBITRATION
  CHEQUE_BOUNCE
}

enum CaseStatus {
  OPEN
  PENDING
  HEARING
  RESERVED
  DISPOSED
  ARCHIVED
  CLOSED
}

enum CaseStage {
  FILING
  NOTICE
  APPEARANCE
  FRAMING_ISSUES
  EVIDENCE
  ARGUMENTS
  RESERVED
  JUDGMENT
  APPEAL
  EXECUTION
}

enum ClientRole {
  PETITIONER
  RESPONDENT
  COMPLAINANT
  ACCUSED
  PLAINTIFF
  DEFENDANT
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  AI_CHAT
  DRAFT_CREATED
  SUMMARY_CREATED
  DOCUMENT_UPLOADED
  HEARING_ADDED
  HEARING_UPDATED
  STATUS_CHANGED
  NOTE_ADDED
  RESEARCH_DONE
  NOTICE_CREATED
  CLIENT_LINKED
  CASE_CREATED
  CASE_UPDATED
}

enum HearingStatus {
  SCHEDULED
  COMPLETED
  ADJOURNED
  CANCELLED
}

enum DocumentType {
  PETITION
  REPLY
  REJOINDER
  AFFIDAVIT
  EVIDENCE
  ORDER
  JUDGMENT
  NOTICE
  DRAFT
  OTHER
}

// ============================================
// EXISTING MODELS (Updated with case linkage)
// ============================================

// Payment records
model Payment {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @map("user_id") @db.Uuid
  plan              Plan
  amount            Int
  currency          String        @default("INR")
  razorpayOrderId   String        @map("razorpay_order_id")
  razorpayPaymentId String?       @map("razorpay_payment_id")
  razorpaySignature String?       @map("razorpay_signature")
  status            PaymentStatus @default(CREATED)
  createdAt         DateTime      @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("payments")
}

// Usage tracking
model UsageEvent {
  id        String      @id @default(uuid()) @db.Uuid
  userId    String      @map("user_id") @db.Uuid
  feature   FeatureType
  count     Int         @default(1)
  createdAt DateTime    @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, feature], name: "userId_feature")
  @@index([userId, createdAt])
  @@map("usage_events")
}

// Research queries - NOW WITH CASE LINKAGE
model Research {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  caseId    String?  @map("case_id") @db.Uuid // Case linkage
  query     String
  result    String
  type      String   @default("general")
  createdAt DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([caseId])
  @@map("research")
}

// Legal drafts - NOW WITH CASE LINKAGE
model Draft {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  caseId    String?  @map("case_id") @db.Uuid // Case linkage
  type      String
  title     String
  content   String
  inputs    Json
  pdfUrl    String?  @map("pdf_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@map("drafts")
}

// Judgment summaries - NOW WITH CASE LINKAGE
model Summary {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  caseId       String?  @map("case_id") @db.Uuid // Case linkage
  title        String
  originalText String   @map("original_text")
  summary      String
  fileUrl      String?  @map("file_url")
  createdAt    DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@map("summaries")
}

// Case tracking (legacy - will migrate to Case model)
model CaseTracker {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  cnr        String    @unique
  partyName  String    @map("party_name")
  court      String
  status     String
  nextDate   DateTime? @map("next_date")
  lastUpdate DateTime  @map("last_update")
  details    Json?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("case_tracker")
}

// Legal notices - NOW WITH CASE LINKAGE
model Notice {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  caseId    String?  @map("case_id") @db.Uuid // Case linkage
  type      String
  title     String
  content   String
  recipient String
  status    String   @default("draft")
  pdfUrl    String?  @map("pdf_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([caseId])
  @@map("notices")
}

// CRM data (legacy - will use Client model)
model CRM {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  clientName  String    @map("client_name")
  clientEmail String?   @map("client_email")
  clientPhone String?   @map("client_phone")
  title       String
  description String?
  date        DateTime
  duration    Int       @default(60)
  status      String    @default("scheduled")
  reminders   Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("crm")
}

// Acts data
model Act {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  year      String
  actId     String   @map("act_id")
  content   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("acts")
}

// News articles
model News {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String
  content     String
  summary     String?
  source      String
  url         String
  publishedAt DateTime @map("published_at")
  category    String?
  tags        String[]
  createdAt   DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("news")
}

// Chat sessions - NOW WITH PROPER CASE LINKAGE
model ChatSession {
  id        String        @id @default(uuid()) @db.Uuid
  userId    String        @map("user_id") @db.Uuid
  caseId    String?       @map("case_id") @db.Uuid // Proper case linkage
  title     String
  messages  ChatMessage[]
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@map("chat_sessions")
}

// Chat messages
model ChatMessage {
  id          String      @id @default(uuid()) @db.Uuid
  sessionId   String      @map("session_id") @db.Uuid
  role        String      // 'user' | 'assistant'
  content     String
  citations   String[]
  attachments Json?       // File attachments metadata
  createdAt   DateTime    @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

// Uploaded files
model UploadedFile {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  caseId     String?  @map("case_id") @db.Uuid // Case linkage
  filename   String
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  content    String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  embeddings DocumentEmbedding[]
  
  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@map("uploaded_files")
}

// Audit logs
model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  action    String
  resource  String
  details   String?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  timestamp DateTime @default(now())

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, timestamp])
  @@map("audit_logs")
}

// System Notifications
model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  read      Boolean  @default(false)
  actionUrl String?  @map("action_url")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user UserApp @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("notifications")
}

// RAG Embeddings
model DocumentEmbedding {
  id        String                 @id @default(uuid()) @db.Uuid
  documentId String?               @map("document_id") @db.Uuid
  uploadedFileId String?           @map("uploaded_file_id") @db.Uuid
  content   String
  embedding Unsupported("vector")?
  metadata  Json?
  createdAt DateTime               @default(now()) @map("created_at")

  document     CaseDocument?       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedFile UploadedFile?       @relation(fields: [uploadedFileId], references: [id], onDelete: Cascade)

  @@map("document_embeddings")
}

// Enums
enum Plan {
  FREE
  BASIC
  PLUS
  PRO
}

enum PaymentStatus {
  CREATED
  PAID
  FAILED
}

// Rate limiting table
model RateLimit {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  count     Int      @default(1)
  resetTime DateTime @map("reset_time")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([key, resetTime])
  @@map("rate_limits")
}

enum FeatureType {
  AI_ASSISTANT
  DOC_GENERATOR
  JUDGMENT_SUMMARIZER
  CRM
  ACTS
  NEWS
  CASE_TRACKER
  NOTICES
  DRAFTS
  RESEARCH
}
